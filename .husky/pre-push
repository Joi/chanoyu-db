#!/bin/sh

# Ensure we run from repo root
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT" || exit 1

run_ci=0
# Read refs from stdin to detect branch
while read local_ref local_sha remote_ref remote_sha; do
  case "$remote_ref" in
    refs/heads/main) run_ci=1 ;;
    refs/heads/feature/*) run_ci=1 ;;
  esac
done

if [ "$run_ci" = "1" ]; then
  echo "Running CI (lint+typecheck+tests+build) locally before push..."
  pnpm ci:local || exit 1
fi

# Reminder: make sure commit/PR body includes closing keywords
last_msg="$(git log -1 --pretty=%B)"
echo "$last_msg" | grep -iE '\b(closes|fixes|resolves)\s+#[0-9]+' >/dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "⚠️  Reminder: Include 'Closes #<issue>' in your PR description so GitHub will auto-close the Issue."
fi

exit 0